title: 创建高性能的索引
date: 2016-12-30 10:48:24
---

# 创建高性能的索引

索引优化应该是对查询性能优化最有效的手段。

“好的”索引能很容易地将查询性能提高几个数量级，而“最优”的索引有时能将性能再提升两个数量级。

## 一、索引类型

### 1. B-Tree索引

谈及索引，没有特殊说明的情况下，大多说的是B-Tree索引，使用B-Tree数据结构来存储数据。

MySQL在建立索引时指明的索引类型B-Tree一般情况下只是一个泛指。

实际上，不同的存储引擎会以不同的方式使用B-Tree索引，例如：MyISAM索引使用前缀压缩技术，InnoDB则按原数据格式存储。另外，不同的存储引擎内部实现不一，可视为B-Tree索引的变种，例如：INNODB内部使用的B+Tree，NDB内部使用的T-Tree等。

#### 索引结构示例

![建立在B-Tree结构上的索引](http://o7kubqw1j.bkt.clouddn.com/asserts/images/article/Snip20160829_71.png)

B-Tree所有的值都是按顺序存储的，并且每一个叶子页到根的距离相同。其索引内部节点只存储索引关键字，叶子节点除了存储索引关键字，只额外存储索引指向的数据指针。

相对全表扫描而言，使用B-Tree索引查询关键字找到记录平均查找次数更少、需要进行的I/O次数更少，进而能加快访问数据的速度。

#### 适用性

**B-Tree索引适用于全键值、键值范围或键前缀查找。其中，键前缀查找只适用于根据最左前缀的查找。**

由于B-Tree索引结构的特点，其适用的查询类型有如下几种：

- 全值匹配
- 匹配最左前缀
- 匹配列前缀
- 匹配范围值
- 精确匹配某一列并范围匹配另外一列
- 只访问索引的查询

#### 使用限制

- 如果不是按照索引的最左列开始查询，则无法使用索引。
- 不能跳过索引中的列。
- 如果查询中有某个列的范围查询，则其右边所有列都无法使用索引优化查询。

**B-Tree索引的这些限制都和索引列的顺序有关。**

### 2. 哈希索引

基于哈希表实现，只有精确匹配索引所有列的查询才有效。

使用哈希索引的存储引擎会对数据行所有的索引列计算出一个哈希码，存储到索引中，同时在哈希表中保存指向每个数据行的指针。

如果多个列的哈希值相同，索引会以链表的方式存放多个记录指针到同一个哈杀条目中。

Memory、NDB存储引擎都支持哈希索引。

### 适用性与使用限制

哈希索引自身只需存储对应的哈希值，所有索引的结构十分紧凑，这也让哈希索引的速度非常快。

这一特性也让哈希索引只适用于某些特定的场合。

- 哈希索引只包含哈希值和行指针，而不存储字段值，所以不能使用索引中的值来避免读取行。不过，访问内存中的行的速度很快，一般情况下不会对性能影响不大。
- 哈希索引数据并不是按照索引值顺序存储的，所以也就无法用于排序。
- 哈希索引也不支持部分索引列匹配查询，因为哈希索引始终是使用索引列的全部内容来计算哈希值的。
- 哈希索引只支持等值比较查询(包括：=、in、!=)，不支持任何范围查询。
- 访问哈希索引的数据非常快，除非有很多哈希冲突。

由于这些限制，哈希索引只适用于某些特定的场合。但是，一旦索引场景适合哈希索引，则它带来的性能提升将非常显著。例如：索引列业务场景只存在等值比较的情况。

#### InnoDB自适应哈希索引

由于哈希索引在等值查询的场景下，查询性能非常快。InnoDB引擎在内部索引存储结构B+Tree之上，使用一个自适应哈希索引，用于存储某些使用非常频繁的索引，来进一步提高索引性能。

这一过程是完全自动、内部行为。不过如果有必要的话，也可以关闭该功能。

#### 自定义哈希索引

如果存储引擎不支持哈希索引，则可以模拟像INNODB一样创建哈希索引。思路：在B-Tree基础上创建一个伪哈希索引。这和真正的哈希索引不一样，还是使用B-Tree进行查找，但是这使用哈希值而不是键本身进行索引查找。**这样实现的缺陷是需要维护哈希值。**可以手动维护，也可以使用触发器实现。

我们需要做的就是在查询的WHERE子句中手动指定使用哈希函数。常用的哈希函数有：CRC、SHA1、MD5、移植自Percona Server的FNV64函数等。由于SHA1、MD5是强加密函数，设计目标是最大限度消除冲突，加密后的哈希是非常长的字符串，一会浪费大量空间，二会在比较时更慢，反而会比不用更的情况更糟糕。而CRC加密值为整数，但是加密长度不够，遇到数据表非常大的情况会出现大量的哈希冲突问题。

**数据表非常大的情况，可以考虑实现一个简单的64位哈希函数来减少哈希冲突。**例如：`CONV(RIGHT(MD5(url), 16), 16, 10) AS HASH64`

使用哈希索引进行查询的时候，必须在WHERE子句中包含常量值，用于避免哈希冲突时，无法找到正确的记录。

### 3. 空间数据索引



### 4. 全文索引



### 5. 其他索引类别